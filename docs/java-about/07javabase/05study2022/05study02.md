---
title: 02分布式锁详解
---

## 1. 分布式锁是什么，用来干啥

**单服务**：同时操作一个数据，Lock，sychoinzed

**多服务**：

两台机器：去跑定时任务，会出现跑两次的问题

## 2.Redis的分布式锁如何实现

```
setnx key value
```

如果有key的时候返回0

如果没有key，返回1

删除key

```
del key
```



### 1.流程

先获取锁---》业务代码---〉删除锁

## 2.如果避免死锁

-  1.处理业务代码的时候，系统挂了

- 2.进程挂了，没有释放锁

1、设置过期时间 ；expire

2、finally里面做一个解锁操作

3、被别的服务释放掉了

  

**原子操作**

保证redis的操作是原子操作

lua脚本

## 总结

1. 加锁： set key value expiretime
2. 跑业务代码
3. lun脚步进行解锁

expiretime 如何设置合适的时间

- 冗余操作，设置稍微长一点
- 看门狗机制，守护线程，定时去查看锁的失效时间，如果锁要过期，而且代码还在执行，自动续约



### 问题

以上是redis单机，一主二从三哨兵

### RedLock







